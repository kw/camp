{% extends "character/character_base.html" %}
{% load crispy_forms_tags %}
{% load character_sheet %}
{% load rules %}

{% block content %}

<h2>{{ feature.formal_name }}
    {% if feature.can_increase and feature.purchase_cost_string %} ({{ feature.purchase_cost_string }}){% endif %}
    {% if feature.category %}
    <p class="fw-lighter fs-5">{{ feature.category }}</p>
    {% endif %}
    {% if feature.tag_names %}
    <p class="fw-lighter fs-5">{{ feature.tag_names | join:", " }}</p>
    {% endif %}
</h2>

{% if feature.parent %}
<p>Part of <a href="{% url 'character-feature-view' character.id feature.parent.id %}">{{ feature.parent.display_name }}</a></p>
{% endif %}

{% if purchase_form %}
{% if feature.unused_bonus > 0 %}
<p>You have {{ feature.unused_bonus }} unused bonus rank(s). Your next purchase is free.</p>
{% endif %}

<form method="post" id="purchaseForm">
    {% csrf_token %}
        {{ purchase_form | crispy }}
        {% if purchase_form.show_remove_button %}
        <button type="submit" id="removeButton"
                name="remove" value="1"
                class="btn btn-danger">
            Remove
        </button>
        {% else %}
        <button type="submit" id="purchaseButton" name="purchase"
                class="btn btn-{{purchase_form.button_level}}">
            {{purchase_form.button_label}}
        </button>
        {% endif %}
    </div>
</form>
{% elif no_purchase_reason %}
<p>You can not currently purchase this because:</p>
<p>{{ no_purchase_reason }}</p>
{% endif %}


{% if feature.description %}
<p>{{ feature.description | markdown }}</p>
{% endif %}

{% if explain_ranks %}
<h3>Details</h3>
{% for explanation in explain_ranks %}
<p>{{ explanation | markdown }}</p>
{% endfor %}
{% endif %}

{% if feature.granted_features %}
<h3>Granted Features</h3>
<ul>
{% for subfeat in feature.granted_features %}
<li><a href="{% url 'character-feature-view' character.id subfeat.full_id %}">{{ subfeat.formal_name }}</a></li>
{% endfor %}
</ul>
{% endif %}

{% if feature.discounted_features %}
<h3>Discounted Features</h3>
<ul>
{% for subfeat in feature.discounted_features %}
<li><a href="{% url 'character-feature-view' character.id subfeat.full_id %}">{{ subfeat.display_name }}</a></li>
{% endfor %}
</ul>
{% endif %}

{% if choices %}
<a name="choices"></a>
{% for key, choice in choices.items %}
    {% if choice.controller.limit > 1 %}
    <h3>{{ choice.controller.name }} ({{choice.controller.limit}})</h3>
    {% else %}
    <h3>{{ choice.controller.name }}</h3>
    {% endif %}
    {% if choice.controller.description %}
    <p>{{ choice.controller.description | markdown }}</p>
    {% endif %}
    {% if choice.taken %}
    <h4>Selected Choices</h4>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="unchoose" value="1">
        <input type="hidden" name="choice" value="{{choice.id}}">
        <ul>
            {% for f, name in choice.taken.items %}
            <li><a href="{% url 'character-feature-view' character.id f %}">{{ name }}</a>
                {% if f in choice.removable %}
                    <button type="submit" class="btn btn-danger btn-sm" name="selection" value="{{f}}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                    </svg>
                </button>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </form>
    {% endif %}
    {% if choice.available %}
    <form method="post">
        {% csrf_token %}
        {{ choice | crispy }}
        <button type="submit" name="choice" value="{{choice.id}}" class="btn btn-primary">Choose this option</button>
    </form>
    {% endif %}
{% endfor %}
{% endif %}

{% if subfeatures %}
    <h3>{{subfeatures.0.name}}</h3>
        <ul class="list-group col-12 col-lg-6 col-xl-4">
            {% for group in subfeatures %}
            {% for f in group.taken %}
            <li class="list-group-item">
                <a href="{% url 'character-feature-view' character.id f.full_id %}">
                    {{ f.feature_list_name }}
                    {% if f.can_increase %}
                    ⇧
                    {% if f.purchase_cost_string %}
                        ({{ f.purchase_cost_string }})
                    {% endif %}
                    {% endif %}
                    {% for level, badge in f.badges %}
                    <span class="badge bg-{{level}}">{{badge}}</span>
                    {% endfor %}
                </a>
                {# Yeah I guess subfeatures could have subfeatures... #}
                {% if f.subfeatures %}
                <ul>
                    {% for sf in f.subfeatures %}
                    <li>
                        <a href="{% url 'character-feature-view' character.id sf.full_id%}">
                            {{ sf.formal_name }}
                            {% if sff.can_increase %}
                            ⇧
                                {% if sf.purchase_cost_string %}
                                ({{ sf.purchase_cost_string }})
                                {% endif %}
                            {% endif %}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
            {% endfor %}
        </ul>

    {% for group in subfeatures %}
        {% if group.available %}
        <h4>{{group.name}} Available</h4>
            <ul class="list-group col-12 col-lg-6 col-xl-4">
            {% if group.explain %}
            <li class="list-group-item">
            {{ group.explain }}
            </li>
            {% endif %}

            {% for f in group.available %}
                <li class="list-group-item">
                    <a href="{% url 'character-feature-view' character.id f.full_id%}">
                        {{ f }}
                        {% if f.purchase_cost_string %}
                        ({{ f.purchase_cost_string }})
                        {% endif %}
                    </a>
                </li>
            {% endfor %}
            </ul>
        {% endif %}
    {% endfor %}

    {% for group in subfeatures %}
        {% for category, available in group.available_categories.items %}
        <h4>{{category}} Available</h4>
        <ul class="list-group col-12 col-lg-6 col-xl-4">
            {% if available.0.explain_category_group %}
            <li class="list-group-item">
                {{ available.0.explain_category_group }}
            </li>
            {% endif %}
            {% for f in available %}
            <li class="list-group-item">
                <a href="{% url 'character-feature-view' character.id f.full_id%}">
                    {{ f }}
                    {% if f.purchase_cost_string %}
                    ({{ f.purchase_cost_string }})
                    {% endif %}
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endfor %}
    {% endfor %}

{% endif %}

<a role="button" class="btn btn-secondary" href="{% url 'character-detail' character.id %}">Back to {{character}}</a>

{% endblock %}

{% block javascript %}
<script>
    /* If we have both radio buttons and a freeform option, disable the freeform option unless the "Other" radio button is selected. */
    const other_radio = document.querySelector('input[type="radio"][name="option"][value="__other__"]');
    const option_freeform = document.querySelector("#id_option_freeform");
    if (other_radio && option_freeform) {
        if (other_radio.checked) {
            option_freeform.disabled = false;
            option_freeform.required = true;
        } else {
            option_freeform.disabled = true;
            option_freeform.required = false;
        }
        other_radio.addEventListener("change", function() {
            if (other_radio.checked) {
                option_freeform.disabled = false;
                option_freeform.required = true;
            }
        });
        document.querySelectorAll('input[type="radio"][name="option"]:not([value="__other__"])').forEach(function(radio) {
            radio.addEventListener("change", function() {
                option_freeform.disabled = true;
                option_freeform.required = false;
                option_freeform.value = "";
            });
        });
    }
</script>
{% endblock %}
